# ğŸ§  è®°å¿†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“Š ä¸‰å±‚è®°å¿†æ¶æ„

æœ¬é¡¹ç›®å®ç°äº†æ™ºèƒ½çš„ä¸‰å±‚è®°å¿†ç³»ç»Ÿï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·å¯¹è¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    Memory Service            â”‚
        â”‚    (è®°å¿†ç®¡ç†æœåŠ¡)            â”‚
        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“        â†“          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å¯¹è¯å†å²  â”‚ â”‚ æŒä¹…è®°å¿†  â”‚ â”‚ é¢å¤–è®°å¿†  â”‚
    â”‚ (MySQL)  â”‚ â”‚ (MySQL)  â”‚ â”‚ (Vector) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ å¯¹è¯å†å²ï¼ˆçŸ­æœŸä¸Šä¸‹æ–‡ï¼‰

**å­˜å‚¨**ï¼šMySQL `t_dialogue` è¡¨  
**ç”¨é€”**ï¼šä¿æŒå¯¹è¯è¿è´¯æ€§  
**ç‰¹ç‚¹**ï¼š
- æœ€è¿‘7è½®å¯¹è¯
- æŒ‰æ—¶é—´å€’åº
- å¿«é€Ÿè®¿é—®

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·: ä»Šå¤©å¤©æ°”çœŸå¥½
AI: æ˜¯å•Šï¼Œè¦ä¸è¦å‡ºå»èµ°èµ°
ç”¨æˆ·: æ™šä¸Šæƒ³åƒä»€ä¹ˆ
AI: æƒ³åƒä»€ä¹ˆç±»å‹çš„å‘¢
...ï¼ˆæœ€è¿‘7è½®ï¼‰
```

---

## 2ï¸âƒ£ æŒä¹…åŒ–è®°å¿†ï¼ˆç”¨æˆ·ç‰¹å¾ - æ ¸å¿ƒåŠŸèƒ½ï¼‰â­

**å­˜å‚¨**ï¼šMySQL `chat_memory` è¡¨  
**ç”¨é€”**ï¼šè®°ä½ç”¨æˆ·çš„ç‰¹å¾å’Œé‡è¦ä¿¡æ¯  
**å¯ç”¨**ï¼šé»˜è®¤å¯ç”¨ï¼ˆå¯é…ç½®ï¼‰

### ğŸ“‹ æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE chat_memory (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    robot_id VARCHAR(255) NOT NULL,  -- è§’è‰²ID
    short_term_memory TEXT,          -- çŸ­æœŸè®°å¿†
    long_term_memory TEXT,           -- é•¿æœŸè®°å¿†
    conversation_count INT,          -- å¯¹è¯è®¡æ•°
    created_at DATETIME,
    updated_at DATETIME
);
```

### ğŸ¤– LLM è‡ªåŠ¨åˆ†ç±»

æ¯æ¬¡å¯¹è¯åï¼ŒLLMè‡ªåŠ¨åˆ¤æ–­è®°å¿†ç±»å‹ï¼š

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ | å¤„ç†æ–¹å¼ |
|------|------|------|---------|
| **none** | æ—¥å¸¸å£æ°´è¯ | "å¥½çš„"ã€"å“ˆå“ˆ"ã€"ä½ çœŸå¯çˆ±" | ä¸è®°å¿†ï¼Œä»…è®¡æ•° |
| **short_term** | æœ€è¿‘å‘ç”Ÿçš„äº‹ | "æˆ‘æ˜¨å¤©åƒäº†ç«é”…"ã€"ä»Šå¤©å»å¥èº«æˆ¿" | ç¼“å­˜ï¼Œ10è½®åæ‰¹é‡æ›´æ–° |
| **long_term** | ç”¨æˆ·ç‰¹å¾åå¥½ | "æˆ‘å–œæ¬¢åƒè¾£çš„"ã€"æˆ‘æ˜¯ç¨‹åºå‘˜" | ç«‹å³æ›´æ–°åˆ°DB |

### ğŸ“ è®°å¿†æ›´æ–°ç­–ç•¥

**çŸ­æœŸè®°å¿†**ï¼ˆ10è½®æ‰¹é‡æ›´æ–°ï¼‰ï¼š
```
å¯¹è¯1: "æˆ‘æ˜¨å¤©åƒäº†ç«é”…" â†’ ç¼“å­˜
å¯¹è¯2: "ä»Šå¤©å»äº†å¥èº«æˆ¿" â†’ ç¼“å­˜
...
å¯¹è¯10: "åˆšæ‰é‡åˆ°è€æœ‹å‹" â†’ ç¼“å­˜
â†’ è¾¾åˆ°10è½®ï¼Œæ‰¹é‡æ›´æ–°åˆ° MySQL
```

**ä¸ºä»€ä¹ˆ10è½®æ‰¹é‡ï¼Ÿ**
- âœ… å‡å°‘æ•°æ®åº“å†™å…¥æ¬¡æ•°
- âœ… LLMå·²ç»åˆ¤æ–­å€¼å¾—è®°å¿†ï¼Œä½†ä¸ç´§æ€¥
- âœ… æ‰¹é‡æ›´æ–°å¯ä»¥å»é‡å’Œæ•´ç†

**é•¿æœŸè®°å¿†**ï¼ˆç«‹å³æ›´æ–°ï¼‰ï¼š
```
å¯¹è¯: "æˆ‘å–œæ¬¢åƒè¾£çš„" 
â†’ LLMåˆ¤æ–­ä¸ºé•¿æœŸè®°å¿†
â†’ ç«‹å³æ›´æ–°åˆ° MySQL long_term_memory å­—æ®µ
```

**ä¸ºä»€ä¹ˆç«‹å³æ›´æ–°ï¼Ÿ**
- âœ… é‡è¦çš„ç”¨æˆ·ç‰¹å¾ï¼Œéœ€è¦é©¬ä¸Šç”Ÿæ•ˆ
- âœ… ä¸‹æ¬¡å¯¹è¯å°±èƒ½å¼•ç”¨è¿™ä¸ªä¿¡æ¯

### ğŸ”§ é…ç½®æ–¹å¼

```yaml
# src/config.yaml

persistent_memory:
  enabled: true  # å…¨å±€å¼€å…³
  short_term_update_interval: 10  # æ¯10è½®æ›´æ–°çŸ­æœŸè®°å¿†
  enabled_characters:  # å¯ç”¨è®°å¿†çš„è§’è‰²ï¼ˆç©º=å…¨éƒ¨ï¼‰
    - "default"
    - "c1s1c1_0001"
```

**æ’ä»¶å¼è®¾è®¡**ï¼š
- `enabled: false` â†’ å®Œå…¨å…³é—­ï¼Œä¸è°ƒç”¨LLMåˆ¤æ–­ï¼Œä¸ä¿å­˜
- `enabled_characters: ["default"]` â†’ åªä¸ºæŒ‡å®šè§’è‰²å¯ç”¨

---

## 3ï¸âƒ£ é¢å¤–è®°å¿†ï¼ˆè¯­ä¹‰æ£€ç´¢ - å¯é€‰åŠŸèƒ½ï¼‰

**å­˜å‚¨**ï¼šQdrant å‘é‡æ•°æ®åº“  
**ç”¨é€”**ï¼šæ‰¾åˆ°è¯­ä¹‰ç›¸ä¼¼çš„å†å²å¯¹è¯  
**å¯ç”¨**ï¼šå¯é€‰ï¼ˆéœ€è¦å®‰è£… qdrant-clientï¼‰

### ğŸ” å·¥ä½œåŸç†

```
å½“å‰æ¶ˆæ¯: "æˆ‘æƒ³åƒç«é”…"
    â†“
Embedding å‘é‡åŒ–
    â†“
å‘é‡: [0.123, -0.456, ...]
    â†“
Qdrant ç›¸ä¼¼åº¦æœç´¢
    â†“
æ‰¾åˆ°ï¼š
  - "æˆ‘å–œæ¬¢åƒè¾£çš„"ï¼ˆ3ä¸ªæœˆå‰ï¼Œç›¸ä¼¼åº¦0.85ï¼‰
  - "éº»è¾£çƒ«çœŸå¥½åƒ"ï¼ˆ1å‘¨å‰ï¼Œç›¸ä¼¼åº¦0.78ï¼‰
    â†“
è¿”å›è¿™äº›ç›¸å…³å¯¹è¯ä½œä¸ºé¢å¤–ä¸Šä¸‹æ–‡
```

### ğŸ”§ é…ç½®æ–¹å¼

```yaml
# src/config.yaml

vector_db:
  enabled: true  # å¯ç”¨é¢å¤–è®°å¿†
  url: "http://localhost:6333"
  collection_name: "conversations"
  embedding_api_key: "sk-xxx"
```

**ä¾èµ–å®‰è£…**ï¼š
```bash
uv pip install qdrant-client
```

---

## ğŸ¯ å®Œæ•´çš„è®°å¿†æµç¨‹

### ğŸ“¥ è¾“å…¥é˜¶æ®µï¼ˆè·å–è®°å¿†ï¼‰

```python
# ç”¨æˆ·å‘é€ï¼š"æˆ‘æƒ³åƒç«é”…"

# ç³»ç»Ÿè·å–ä¸‰ç§è®°å¿†ï¼š
memories = {
    # 1. å¯¹è¯å†å²ï¼ˆæœ€è¿‘7è½®ï¼‰
    "conversation_history": [
        {"role": "user", "content": "ä»Šå¤©å¤©æ°”çœŸå¥½"},
        {"role": "assistant", "content": "æ˜¯å•Š"},
        ...  # æœ€è¿‘7è½®
    ],
    
    # 2. æŒä¹…åŒ–è®°å¿†ï¼ˆchat_memoryè¡¨ï¼‰
    "persistent": {
        "long_term": "[2025-10-15] æˆ‘å–œæ¬¢åƒè¾£çš„\n[2025-09-20] æˆ‘æ˜¯ç¨‹åºå‘˜",
        "short_term": "[2025-11-01] æˆ‘æ˜¨å¤©åŠ ç­åˆ°å¾ˆæ™š\n[2025-11-03] ä»Šå¤©å»äº†å¥èº«æˆ¿"
    },
    
    # 3. é¢å¤–è®°å¿†ï¼ˆå‘é‡æ£€ç´¢ï¼Œå¯é€‰ï¼‰
    "vector": [
        {"role": "user", "content": "éº»è¾£çƒ«çœŸå¥½åƒ"},  # ç›¸ä¼¼åº¦0.78
        {"role": "assistant", "content": "ä¸‹æ¬¡å¸¦ä½ å»åƒ"}
    ]
}

# å‘é€ç»™LLMï¼š
prompt = f"""
å¯¹è¯å†å²ï¼š{conversation_history}

ã€ç”¨æˆ·é•¿æœŸç‰¹å¾ã€‘
{persistent.long_term}

ã€æœ€è¿‘äº‹ä»¶ã€‘
{persistent.short_term}

å½“å‰æ¶ˆæ¯ï¼šæˆ‘æƒ³åƒç«é”…
"""
```

### ğŸ“¤ è¾“å‡ºé˜¶æ®µï¼ˆä¿å­˜è®°å¿†ï¼‰

```python
# AIå›å¤åï¼š

# 1. LLMåˆ¤æ–­è®°å¿†ç±»å‹
classification = await llm.classify({
    "user": "æˆ‘æƒ³åƒç«é”…",
    "ai": "å¥½å•Šï¼Œå»åƒéº»è¾£çš„å§"
})
# ç»“æœ: "none" (æ—¥å¸¸å¯¹è¯ï¼Œä¸éœ€è¦ç‰¹åˆ«è®°å¿†)

# 2. æ ¹æ®ç±»å‹å¤„ç†
if classification == "short_term":
    # ç¼“å­˜ï¼Œ10è½®åæ›´æ–°
    cache.add("æˆ‘æƒ³åƒç«é”…")
    count++
    if count >= 10:
        update_to_mysql(cache)

elif classification == "long_term":
    # ç«‹å³æ›´æ–°
    update_to_mysql_now("æˆ‘å–œæ¬¢åƒè¾£çš„")

# 3. é¢å¤–è®°å¿†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if vector_db_enabled:
    vector_db.store("æˆ‘æƒ³åƒç«é”…", "å¥½å•Šï¼Œå»åƒéº»è¾£çš„å§")
```

---

## ğŸ›ï¸ é…ç½®é€‰é¡¹è¯¦è§£

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# src/config.yaml

# ===== æŒä¹…åŒ–è®°å¿†é…ç½® =====
persistent_memory:
  enabled: true  # å…¨å±€å¼€å…³
  
  short_term_update_interval: 10  # æ¯Nè½®æ›´æ–°çŸ­æœŸè®°å¿†
  
  enabled_characters:  # å¯ç”¨è®°å¿†çš„è§’è‰²
    # ç•™ç©º [] = æ‰€æœ‰è§’è‰²éƒ½å¯ç”¨
    # æˆ–æŒ‡å®šè§’è‰²ï¼š
    - "default"
    - "c1s1c1_0001"
    # å…¶ä»–è§’è‰²ä¸å¯ç”¨è®°å¿†åŠŸèƒ½

# ===== å‘é‡æ•°æ®åº“é…ç½®ï¼ˆå¯é€‰ï¼‰=====
vector_db:
  enabled: false  # æ˜¯å¦å¯ç”¨é¢å¤–è®°å¿†
  url: "http://localhost:6333"
  api_key: ""
  collection_name: "conversations"
  embedding_api_key: "sk-xxx"
  embedding_url: "https://api.siliconflow.cn/v1/embeddings"
```

### é…ç½®ç»„åˆ

| æŒä¹…åŒ–è®°å¿† | å‘é‡æ£€ç´¢ | æ•ˆæœ |
|-----------|---------|------|
| âœ… enabled | âœ… enabled | å®Œæ•´åŠŸèƒ½ï¼ˆæ¨èï¼‰ |
| âœ… enabled | âŒ disabled | åªæœ‰LLMè®°å¿†ï¼Œæ— é¢å¤–æ£€ç´¢ |
| âŒ disabled | âœ… enabled | åªæœ‰å‘é‡æ£€ç´¢ï¼Œæ— LLMåˆ¤æ–­ |
| âŒ disabled | âŒ disabled | åªæœ‰å¯¹è¯å†å²ï¼ˆåŸºç¡€ï¼‰ |

---

## ğŸ”§ API æ¥å£

### è·å–ç”¨æˆ·ç”»åƒ

```http
GET /pillow/memory/{user_id}/profile?character_id=default
```

**å“åº”**ï¼š
```json
{
  "user_id": "1000003",
  "character_id": "default",
  "short_term_summary": "[2025-11-01] æˆ‘æ˜¨å¤©åŠ ç­åˆ°å¾ˆæ™š...",
  "long_term_profile": "[2025-10-15] æˆ‘å–œæ¬¢åƒè¾£çš„...",
  "stats": {
    "conversation_count": 45,
    "pending_short_term": 3,
    "remaining_rounds": 7
  }
}
```

### è·å–è®°å¿†ç»Ÿè®¡

```http
GET /pillow/memory/{user_id}/stats?character_id=default
```

**å“åº”**ï¼š
```json
{
  "exists": true,
  "conversation_count": 45,
  "short_term_length": 523,
  "long_term_length": 1234,
  "pending_short_term": 3,
  "remaining_rounds": 7,
  "last_update": "2025-11-04T15:30:00"
}
```

### æ¸…é™¤ç”¨æˆ·è®°å¿†

```http
DELETE /pillow/memory/{user_id}?character_id=default
```

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå…³é—­æ‰€æœ‰è®°å¿†åŠŸèƒ½

```yaml
persistent_memory:
  enabled: false
vector_db:
  enabled: false
```

**æ•ˆæœ**ï¼šåªä½¿ç”¨å¯¹è¯å†å²ï¼Œä¸åšä»»ä½•è®°å¿†æå–å’Œå­˜å‚¨

---

### åœºæ™¯2ï¼šåªå¯ç”¨æŸäº›è§’è‰²çš„è®°å¿†

```yaml
persistent_memory:
  enabled: true
  enabled_characters:
    - "default"  # åªå¯¹é»˜è®¤è§’è‰²å¯ç”¨
    # å…¶ä»–è§’è‰²ï¼ˆå¦‚ c1s1c1_0001ï¼‰ä¸å¯ç”¨
```

**æ•ˆæœ**ï¼š
- `default` è§’è‰²ï¼šæœ‰LLMè®°å¿†åŠŸèƒ½
- å…¶ä»–è§’è‰²ï¼šæ— è®°å¿†åŠŸèƒ½ï¼ŒèŠ‚çœLLMè°ƒç”¨

---

### åœºæ™¯3ï¼šå®Œæ•´è®°å¿†åŠŸèƒ½

```yaml
persistent_memory:
  enabled: true
  enabled_characters: []  # ç©º=å…¨éƒ¨å¯ç”¨

vector_db:
  enabled: true
```

**æ•ˆæœ**ï¼š
- æ‰€æœ‰è§’è‰²éƒ½æœ‰è®°å¿†åŠŸèƒ½
- åŒ…æ‹¬LLMåˆ¤æ–­çš„è®°å¿† + å‘é‡è¯­ä¹‰æ£€ç´¢

---

## ğŸ“ˆ è®°å¿†ç¤ºä¾‹

### å¯¹è¯ç¤ºä¾‹

```
[ç¬¬1è½®]
ç”¨æˆ·: æˆ‘å«å¼ ä¸‰ï¼Œæ˜¯ä¸ªç¨‹åºå‘˜
AI: ä½ å¥½å¼ ä¸‰ï¼
â†’ LLMåˆ¤æ–­: long_term
â†’ å­˜å‚¨: "æˆ‘æ˜¯ç¨‹åºå‘˜" â†’ long_term_memoryï¼ˆç«‹å³ï¼‰

[ç¬¬2è½®]
ç”¨æˆ·: æ˜¨å¤©åŠ ç­åˆ°å¾ˆæ™š
AI: è¾›è‹¦äº†
â†’ LLMåˆ¤æ–­: short_term
â†’ ç¼“å­˜: count=1, pending=["æ˜¨å¤©åŠ ç­åˆ°å¾ˆæ™š"]

[ç¬¬3è½®]
ç”¨æˆ·: å¥½çš„
AI: å—¯å—¯
â†’ LLMåˆ¤æ–­: noneï¼ˆæ—¥å¸¸åº”ç­”ï¼‰
â†’ ä¸è®°å¿†ï¼Œcount=2

[ç¬¬10è½®]
ç”¨æˆ·: ä»Šå¤©å»äº†å¥èº«æˆ¿
AI: çœŸæ£’
â†’ LLMåˆ¤æ–­: short_term
â†’ ç¼“å­˜: count=10, pending=[...]
â†’ è¾¾åˆ°10è½®ï¼æ‰¹é‡æ›´æ–°ï¼š
   short_term_memory = "
[2025-11-01] æ˜¨å¤©åŠ ç­åˆ°å¾ˆæ™š
[2025-11-02] ä»Šå¤©å¿ƒæƒ…ä¸é”™
...
[2025-11-04] ä»Šå¤©å»äº†å¥èº«æˆ¿
"

[ç¬¬15è½®]
ç”¨æˆ·: æˆ‘å–œæ¬¢åƒè¾£çš„
AI: è®°ä½å•¦
â†’ LLMåˆ¤æ–­: long_term
â†’ ç«‹å³æ›´æ–°: long_term_memory += "\n[2025-11-04] æˆ‘å–œæ¬¢åƒè¾£çš„"
```

### è®°å¿†ä½¿ç”¨ç¤ºä¾‹

```
[å‡ å¤©å]
ç”¨æˆ·: æ¨èä¸ªé¤å…
AI: (ç³»ç»Ÿè¯»å–)
    long_term: "æˆ‘æ˜¯ç¨‹åºå‘˜ï¼Œæˆ‘å–œæ¬¢åƒè¾£çš„"
    short_term: "æœ€è¿‘åŠ ç­ï¼Œä»Šå¤©å»äº†å¥èº«æˆ¿"
â†’ AI: "æ¨èä½ å»åƒå·èœï¼è¾£çš„èƒ½ç¼“è§£åŠ ç­ç–²åŠ³ï¼Œè€Œä¸”å¥èº«ååƒç‚¹å¥½çš„çŠ’åŠ³è‡ªå·±~"
    â†‘         â†‘                â†‘                    â†‘
  é•¿æœŸè®°å¿†   é•¿æœŸè®°å¿†          çŸ­æœŸè®°å¿†              çŸ­æœŸè®°å¿†
```

---

## ğŸ›ï¸ é«˜çº§é…ç½®

### è°ƒæ•´æ›´æ–°é¢‘ç‡

```yaml
persistent_memory:
  short_term_update_interval: 5  # æ”¹ä¸ºæ¯5è½®æ›´æ–°ï¼ˆæ›´é¢‘ç¹ï¼‰
```

### åªå¯¹éƒ¨åˆ†è§’è‰²å¯ç”¨

```yaml
persistent_memory:
  enabled_characters:
    - "default"      # ä¸»è§’è‰²å¯ç”¨
    - "c1s1c1_0001"  # ç‰¹å®šè§’è‰²å¯ç”¨
    # å…¶ä»–è§’è‰²ä¸å¯ç”¨ï¼ŒèŠ‚çœLLMè°ƒç”¨æˆæœ¬
```

### å®Œå…¨å…³é—­è®°å¿†åŠŸèƒ½

```yaml
persistent_memory:
  enabled: false  # å®Œå…¨å…³é—­
```

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è®°å¿†çŠ¶æ€

```bash
curl http://localhost:8000/pillow/memory/1000003/stats?character_id=default
```

**å“åº”**ï¼š
```json
{
  "conversation_count": 23,
  "short_term_length": 456,
  "long_term_length": 789,
  "pending_short_term": 3,
  "remaining_rounds": 7,
  "message": "è¿˜éœ€7è½®å¯¹è¯åæ›´æ–°çŸ­æœŸè®°å¿†"
}
```

### æŸ¥çœ‹ç”¨æˆ·ç”»åƒ

```bash
curl http://localhost:8000/pillow/memory/1000003/profile?character_id=default
```

### æ—¥å¿—ä¸­æŸ¥çœ‹åˆ†ç±»ç»“æœ

```
2025-11-04 15:30:00 | INFO | Memory classification: type=long_term, content=æˆ‘å–œæ¬¢åƒè¾£çš„
2025-11-04 15:31:00 | INFO | Long-term memory updated
2025-11-04 15:32:00 | INFO | Short-term memory cached, remaining: 8 rounds
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ›´æ–°å‡å°‘æ•°æ®åº“å‹åŠ›

çŸ­æœŸè®°å¿†10è½®æ‰¹é‡æ›´æ–°ï¼Œè€Œä¸æ˜¯æ¯è½®éƒ½å†™æ•°æ®åº“

### 2. å†…å­˜ç¼“å­˜

```python
# çŸ­æœŸè®°å¿†åœ¨å†…å­˜ä¸­ç¼“å­˜
_short_term_cache = {
    "user_123:default": {
        "memories": ["æ˜¨å¤©åŠ ç­", "ä»Šå¤©å¥èº«"],
        "count": 8
    }
}
```

### 3. ä¼˜é›…é™çº§

```python
# æŒä¹…åŒ–è®°å¿†åŠŸèƒ½æ•…éšœæ—¶
try:
    await persistent_memory.process(...)
except:
    # ä¸å½±å“ä¸»å¯¹è¯åŠŸèƒ½
    logger.error("Memory processing failed")
    continue_with_chat()
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: å¦‚æœæœåŠ¡é‡å¯ï¼Œç¼“å­˜çš„çŸ­æœŸè®°å¿†ä¼šä¸¢å¤±å—ï¼Ÿ

**A**: ä¼šçš„ã€‚å†…å­˜ç¼“å­˜åœ¨é‡å¯åæ¸…ç©ºã€‚ä½†å½±å“ä¸å¤§ï¼š
- ä¸¢å¤±çš„åªæ˜¯æœªè¾¾åˆ°10è½®çš„ç¼“å­˜
- å¯¹è¯å†å²(t_dialogue)ä¸å—å½±å“
- å¯ä»¥åœ¨å…³é—­äº‹ä»¶ä¸­å¼ºåˆ¶åˆ·æ–°ç¼“å­˜

### Q: å¦‚ä½•å…³é—­æŸä¸ªè§’è‰²çš„è®°å¿†ï¼Ÿ

**A**: åœ¨é…ç½®ä¸­æŒ‡å®šå¯ç”¨çš„è§’è‰²ï¼š
```yaml
persistent_memory:
  enabled_characters:
    - "default"  # åªå¯ç”¨è¿™ä¸ª
```

### Q: LLMåˆ¤æ–­é”™è¯¯æ€ä¹ˆåŠï¼Ÿ

**A**: 
- åˆ¤æ–­å¾ˆå¿«ï¼Œå¤±è´¥ä¸å½±å“å¯¹è¯
- temperature=0.3 ä¿è¯åˆ¤æ–­ä¸€è‡´æ€§
- å³ä½¿åˆ¤æ–­é”™è¯¯ï¼Œä¹Ÿåªæ˜¯å¤šå­˜æˆ–å°‘å­˜ï¼Œä¸å½±å“åŠŸèƒ½

---

## ğŸ“ æ•°æ®åº“è¿ç§»

å¦‚æœä½ çš„æ•°æ®åº“æ²¡æœ‰ `chat_memory` è¡¨ï¼Œéœ€è¦åˆ›å»ºï¼š

```sql
CREATE TABLE chat_memory (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL COMMENT 'ç”¨æˆ·ID',
    robot_id VARCHAR(255) NOT NULL COMMENT 'æœºå™¨äººID',
    short_term_memory TEXT COMMENT 'çŸ­æœŸè®°å¿†',
    long_term_memory TEXT COMMENT 'é•¿æœŸè®°å¿†',
    conversation_count INT DEFAULT 0 COMMENT 'å¯¹è¯è½®æ¬¡è®¡æ•°',
    last_daily_update DATETIME DEFAULT '1970-01-01 00:00:00',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_robot (user_id, robot_id)
);
```

---

**ğŸ‰ ä¸‰å±‚è®°å¿†ç³»ç»Ÿï¼Œè®©AIå¯¹è¯æ›´æ™ºèƒ½ã€æ›´ä¸ªæ€§åŒ–ï¼**

