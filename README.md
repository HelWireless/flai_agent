# æ·±å£¤ Agent

AIå¯¹è¯ä»£ç†æœåŠ¡ï¼ŒåŸºäºFastAPIæ„å»ºï¼Œæ”¯æŒå¤šè§’è‰²å¯¹è¯ã€æƒ…ç»ªåˆ†æã€è¯­éŸ³åˆæˆç­‰åŠŸèƒ½ã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

- ğŸ¤– å¤šè§’è‰²AIå¯¹è¯ç³»ç»Ÿ
- ğŸ§  **é•¿çŸ­æœŸè®°å¿†**ï¼ˆæ”¯æŒè¯­ä¹‰æ£€ç´¢ï¼‰
- ğŸ˜Š æ™ºèƒ½æƒ…ç»ªè¯†åˆ«ä¸åˆ†æ
- ğŸ”Š æ–‡å­—è½¬è¯­éŸ³ï¼ˆTTSï¼‰
- ğŸ´ å åœæŠ½å¡åŠŸèƒ½
- ğŸ›¡ï¸ æ•æ„Ÿå†…å®¹è¿‡æ»¤
- ğŸ’¾ å¯¹è¯å†å²è®°å½•
- â˜ï¸ OSSäº‘å­˜å‚¨é›†æˆ
- ğŸ”¥ é…ç½®çƒ­æ›´æ–°

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.11+
- MySQL æ•°æ®åº“
- é˜¿é‡Œäº‘OSSï¼ˆç”¨äºè¯­éŸ³æ–‡ä»¶å­˜å‚¨ï¼‰
- Qdrant å‘é‡æ•°æ®åº“ï¼ˆå¯é€‰ï¼Œç”¨äºé•¿æœŸè®°å¿†åŠŸèƒ½ï¼‰

### 2. ä½¿ç”¨ UV æ„å»ºç¯å¢ƒ

**å®‰è£… UV**ï¼š

**Linux/macOS ç”¨æˆ·**ï¼š
```bash
# ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰
curl -LsSf https://astral.sh/uv/install.sh | sh

# æˆ–ä½¿ç”¨ pipx å®‰è£…
pipx install uv

# æˆ–ä½¿ç”¨ pip å®‰è£…
pip install uv
```

**Windows ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤**ï¼š
```powershell
# åœ¨ PowerShell ä¸­å®‰è£…
winget install astral-sh.uv

# æˆ–ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–**ï¼š
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv

# æ¿€æ´»ç¯å¢ƒ
source .venv/bin/activate  # Linux/macOS
# æˆ– .venv\Scripts\Activate.ps1  # Windows

# å®‰è£…ä¾èµ–
uv pip install -r requirements.txt
```

### 3. é…ç½®æ–‡ä»¶

```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp config/config.yaml.example config/config.yaml

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¡«å…¥å®é™…çš„æ•°æ®åº“ã€APIå¯†é’¥ç­‰ä¿¡æ¯
vim config/config.yaml
```

### 4. å¯åŠ¨é¡¹ç›®

**å¼€å‘æ¨¡å¼ï¼ˆæ¨èï¼‰**ï¼š
```bash
# æ–¹å¼1ï¼šUV è‡ªåŠ¨ç®¡ç†ç¯å¢ƒï¼ˆæ— éœ€æ‰‹åŠ¨æ¿€æ´»ï¼‰
uv run python src/main.py

# æ–¹å¼2ï¼šæ¿€æ´»ç¯å¢ƒåè¿è¡Œ
source .venv/bin/activate  # Linux/macOS
# æˆ– .venv\Scripts\Activate.ps1  # Windows
python src/main.py
```

**ç”Ÿäº§æ¨¡å¼ï¼ˆé«˜çº§é…ç½®ï¼‰**ï¼š
```bash
# ä½¿ç”¨ uvicorn é«˜çº§é…ç½®è¿è¡Œï¼ˆå¤šè¿›ç¨‹ã€ä»£ç†å¤´ç­‰ï¼‰
source .venv/bin/activate  # Linux/macOS
# æˆ– .venv\Scripts\Activate.ps1  # Windows

# ä½¿ç”¨é«˜çº§é…ç½®è¿è¡Œ
uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 3 --proxy-headers --forwarded-allow-ips="*"

# åå°è¿è¡Œ
nohup uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 3 --proxy-headers --forwarded-allow-ips="*" > logs/app.log 2>&1 &
```

**è®¿é—®æœåŠ¡**ï¼š
- API æ–‡æ¡£ï¼šhttp://localhost:8000/docs
- äº¤äº’å¼æ–‡æ¡£ï¼šhttp://localhost:8000/redoc

## ğŸ“ é¡¹ç›®ç»“æ„

```
flai_agent/
â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ prompts/              # Prompté…ç½®ï¼ˆJSONæ ¼å¼ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼‰
â”‚   â”‚   â”œâ”€â”€ characters.json   # è§’è‰²ç³»ç»Ÿé…ç½®
â”‚   â”‚   â”œâ”€â”€ character_openers.json  # è§’è‰²å¼€åœºç™½
â”‚   â”‚   â”œâ”€â”€ emotion_states.json     # æƒ…ç»ªçŠ¶æ€é…ç½®
â”‚   â”‚   â”œâ”€â”€ responses.json    # å›å¤é…ç½®
â”‚   â”‚   â””â”€â”€ constants.json    # å¸¸é‡é…ç½®
â”‚   â””â”€â”€ llm_params.json       # LLMå‚æ•°é…ç½®
â”œâ”€â”€ data/                      # æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ sensitive_words.txt   # æ•æ„Ÿè¯åˆ—è¡¨
â”œâ”€â”€ logs/                      # è¿è¡Œæ—¶æ—¥å¿—ï¼ˆæŒ‰å‘¨åˆ’åˆ†ï¼ŒæŒ‰æœˆå½’æ¡£ï¼‰
â”‚   â”œâ”€â”€ 2025-10/              # 2025å¹´10æœˆçš„æ—¥å¿—
â”‚   â”‚   â””â”€â”€ 2025-10-27_2025-11-02.log
â”‚   â””â”€â”€ 2025-11/              # 2025å¹´11æœˆçš„æ—¥å¿—
â”‚       â””â”€â”€ 2025-11-03_2025-11-09.log
â”œâ”€â”€ scripts/                   # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ log_extractor.py      # æ—¥å¿—æå–å·¥å…·
â”‚   â””â”€â”€ log_extractor.sh
â”œâ”€â”€ src/                       # æºä»£ç 
â”‚   â”œâ”€â”€ api/                  # APIå±‚
â”‚   â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â”‚   â””â”€â”€ generate_prompts.py
â”‚   â”‚   â””â”€â”€ routes.py         # APIè·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ config_loader.py  # é…ç½®åŠ è½½å™¨ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
â”‚   â”‚   â”œâ”€â”€ content_filter.py # å†…å®¹è¿‡æ»¤
â”‚   â”‚   â””â”€â”€ dialogue_query.py # å¯¹è¯æŸ¥è¯¢
â”‚   â”œâ”€â”€ models/               # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ chat_memory.py    # èŠå¤©è®°å¿†æ¨¡å‹
â”‚   â”œâ”€â”€ services/             # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ chat_service.py        # èŠå¤©æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ emotion_service.py     # æƒ…ç»ªæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ fortune_service.py     # å åœæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ llm_service.py         # LLMæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ memory_classifier.py   # è®°å¿†åˆ†ç±»å™¨
â”‚   â”‚   â”œâ”€â”€ memory_service.py      # è®°å¿†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ oss_client.py          # OSSå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ persistent_memory_service.py  # æŒä¹…åŒ–è®°å¿†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ speech_api.py          # è¯­éŸ³API
â”‚   â”‚   â”œâ”€â”€ vector_store.py        # å‘é‡å­˜å‚¨
â”‚   â”‚   â””â”€â”€ voice_service.py       # è¯­éŸ³æœåŠ¡
â”‚   â”œâ”€â”€ custom_logger.py      # è‡ªå®šä¹‰æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ database.py           # æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ main.py               # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ schemas.py            # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ utils.py              # å·¥å…·å‡½æ•°
â”œâ”€â”€ pyproject.toml            # é¡¹ç›®é…ç½®
â”œâ”€â”€ requirements.txt          # ä¾èµ–åˆ—è¡¨
â””â”€â”€ .gitignore
```

## ğŸ”§ API æ–‡æ¡£

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—® Swagger æ–‡æ¡£æŸ¥çœ‹æ‰€æœ‰ API æ¥å£çš„è¯¦ç»†ä½¿ç”¨æ–¹æ³•ï¼š

- **Swagger UI**ï¼šhttp://localhost:8000/docs
- **ReDoc**ï¼šhttp://localhost:8000/redoc

## ğŸ› ï¸ å¼€å‘è¯´æ˜

### æ¶æ„è¯´æ˜

é¡¹ç›®é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼š
- **APIå±‚**ï¼ˆ`routes.py`ï¼‰- çº¯è·¯ç”±å®šä¹‰ï¼Œå‚æ•°éªŒè¯
- **æœåŠ¡å±‚**ï¼ˆ`services/`ï¼‰- ä¸šåŠ¡é€»è¾‘ï¼ŒLLMè°ƒç”¨
- **æ ¸å¿ƒå±‚**ï¼ˆ`core/`ï¼‰- é€šç”¨åŠŸèƒ½ï¼Œæ•°æ®æŸ¥è¯¢
- **é…ç½®å±‚**ï¼ˆ`config/`ï¼‰- JSONé…ç½®ï¼Œæ”¯æŒçƒ­æ›´æ–°

### ä¸‰å±‚è®°å¿†ç³»ç»Ÿ

æœ¬é¡¹ç›®å®ç°æ™ºèƒ½çš„ä¸‰å±‚è®°å¿†æ¶æ„ï¼š

1. **å¯¹è¯å†å²**ï¼ˆMySQLï¼‰- æœ€è¿‘30å¤©20è½®å¯¹è¯ï¼Œä¿æŒè¿è´¯æ€§
2. **æŒä¹…åŒ–è®°å¿†**ï¼ˆMySQL chat_memoryè¡¨ï¼‰- LLMè‡ªåŠ¨æå–ç”¨æˆ·ç‰¹å¾
   - çŸ­æœŸè®°å¿†ï¼šæœ€è¿‘äº‹ä»¶ï¼ˆ"æˆ‘æ˜¨å¤©åƒäº†ç«é”…"ï¼‰â†’ æ¯20è½®å¯¹è¯æ‰¹é‡æ›´æ–°ï¼Œæ—¶é—´ç²¾ç¡®åˆ°ç§’
   - é•¿æœŸè®°å¿†ï¼šç”¨æˆ·åå¥½ï¼ˆ"æˆ‘å–œæ¬¢åƒè¾£çš„"ï¼‰â†’ ç«‹å³æ›´æ–°
   - è‡ªåŠ¨æ•´ç†ï¼šéå½“å¤©çš„å¤šæ¡çŸ­æœŸè®°å¿†ä¼šè‡ªåŠ¨æŒ‰æ—¥æœŸåˆå¹¶æˆä¸€æ¡æ€»ç»“
3. **é¢å¤–è®°å¿†**ï¼ˆQdrantï¼Œå¯é€‰ï¼‰- è¯­ä¹‰ç›¸ä¼¼çš„å†å²å¯¹è¯æ£€ç´¢ï¼ˆç›¸ä¼¼åº¦é˜ˆå€¼0.8ï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š
```
# æŒä¹…åŒ–è®°å¿†ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
persistent_memory:
  enabled: true
  short_term_update_interval: 20
  enabled_characters: []  # ç©º=å…¨éƒ¨å¯ç”¨ï¼Œæˆ–æŒ‡å®šè§’è‰²

# å‘é‡æ£€ç´¢ï¼ˆå¯é€‰ï¼‰
vector_db:
  enabled: false  # æ”¹ä¸º true å¯ç”¨
```

### æ—¶é—´æ„ŸçŸ¥

Pillow è§’è‰²èƒ½å¤Ÿæ„ŸçŸ¥å½“å‰æ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼Œå¹¶åœ¨å›å¤ä¸­è‡ªç„¶åœ°å¼•ç”¨æ—¶é—´æ¦‚å¿µï¼š
- ç³»ç»Ÿè‡ªåŠ¨å°†å½“å‰æ—¶é—´æ³¨å…¥åˆ° system prompt ä¸­
- æ—¶é—´æ ¼å¼ï¼š`YYYYå¹´MMæœˆDDæ—¥ HHç‚¹MMåˆ†SSç§’`
- è§’è‰²ä¼šæ ¹æ®æ—¶é—´ä½¿ç”¨æ¨¡ç³Šè¡¨è¾¾ï¼ˆå¦‚"æ—©ä¸Š"ã€"æ™šä¸Š"ï¼‰ï¼Œå¿…è¦æ—¶ç²¾ç¡®åˆ°åˆ†é’Ÿ

### æƒ…ç»ªå¤„ç†ç³»ç»Ÿ

æœ¬é¡¹ç›®é‡‡ç”¨å¤šå±‚æ¬¡çš„æƒ…ç»ªå¤„ç†æœºåˆ¶ï¼š

1. **æƒ…ç»ªçŠ¶æ€**ï¼šç³»ç»Ÿå†…éƒ¨ç»´æŠ¤çš„æƒ…ç»ªçŠ¶æ€ï¼Œå¦‚ 'happy', 'anger', 'sadness' ç­‰
2. **æƒ…ç»ªè¡¨ç°**ï¼šæ ¹æ®æƒ…ç»ªçŠ¶æ€ç”Ÿæˆçš„å¤–åœ¨è¡¨ç°æè¿°ï¼Œå¦‚ "å¿«ä¹"ã€"æ°”æ„¤" ç­‰
3. **æƒ…ç»ªç¼–ç **ï¼šæœ€ç»ˆç”¨äºæ¥å£è¿”å›çš„æ•°å­—ç¼–ç ï¼Œå¦‚ 1ã€6 ç­‰

æƒ…ç»ªå¤„ç†æµç¨‹ï¼š
1. ç³»ç»Ÿè·å–å½“å‰çš„å†…åœ¨æƒ…ç»ªçŠ¶æ€ï¼ˆå¦‚ 'happy'ï¼‰
2. é€šè¿‡ `emotion_states.json` é…ç½®å°†å†…åœ¨æƒ…ç»ªæ˜ å°„ä¸ºå¤–åœ¨è¡¨ç°æè¿°ï¼ˆå¦‚ "å¿«ä¹"ï¼‰
3. å°†æƒ…ç»ªä¿¡æ¯åµŒå…¥åˆ°æç¤ºè¯ä¸­ï¼Œå¼•å¯¼LLMç”Ÿæˆå…·æœ‰ç›¸åº”æƒ…ç»ªè‰²å½©çš„å›å¤
4. LLMåœ¨ç”Ÿæˆå›å¤æ—¶å¯èƒ½ä¼šè¿”å›æƒ…ç»ªç±»å‹ï¼ˆå¦‚"å¼€å¿ƒ"ï¼‰
5. ç³»ç»Ÿé€šè¿‡ `get_emotion_type` å‡½æ•°å°†æƒ…ç»ªè¡¨ç°è½¬æ¢ä¸ºæ•°å­—ç¼–ç 

### é…ç½®çƒ­æ›´æ–°

é…ç½®æ–‡ä»¶æ”¯æŒçƒ­æ›´æ–°ï¼Œä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶åä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡ï¼š
- `config/prompts/*.json` - æ‰€æœ‰ Prompt é…ç½®
- `config/llm_params.json` - LLM å‚æ•°é…ç½®
- `data/sensitive_words.txt` - æ•æ„Ÿè¯åˆ—è¡¨

### æ·»åŠ æ–°è§’è‰²

ç¼–è¾‘ `config/prompts/characters.json` å’Œ `config/prompts/character_openers.json`ï¼Œæ·»åŠ æ–°çš„è§’è‰²é…ç½®ã€‚

### æ—¥å¿—ç®¡ç†

æ—¥å¿—æŒ‰å‘¨åˆ’åˆ†ï¼Œè‡ªåŠ¨æŒ‰æœˆå½’æ¡£åˆ°æ–‡ä»¶å¤¹ï¼š
- **æ–‡ä»¶å¤¹**ï¼š`logs/YYYY-MM/` (æŒ‰å¼€å§‹æ—¥æœŸçš„æœˆä»½)
- **æ–‡ä»¶å**ï¼š`YYYY-MM-DD_YYYY-MM-DD.log` (å‘¨ä¸€åˆ°å‘¨æ—¥)
- **è‡ªåŠ¨æ¸…ç†**ï¼šè¶…è¿‡6ä¸ªæœˆçš„æ—¥å¿—ä¼šåœ¨æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†

ç¤ºä¾‹ï¼š
```
logs/
â”œâ”€â”€ 2025-10/
â”‚   â””â”€â”€ 2025-10-27_2025-11-02.log  (è·¨æœˆçš„å‘¨ï¼ŒæŒ‰å¼€å§‹æ—¥æœŸå½’æ¡£åˆ°10æœˆ)
â””â”€â”€ 2025-11/
    â””â”€â”€ 2025-11-03_2025-11-09.log
```

æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
# æŸ¥çœ‹å½“å‰å‘¨çš„æ—¥å¿—
tail -f logs/$(date +%Y-%m)/*.log

# æˆ–æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—æ–‡ä»¶
tail -f $(ls -t logs/*/*.log | head -1)

# æå–æŒ‡å®šæ—¶é—´æ®µæ—¥å¿—
./scripts/log_extractor.sh "2025-11-04 10:00" "2025-11-04 11:00" logs/2025-11/*.log
```

### å¸¸ç”¨å‘½ä»¤

```bash
# æ·»åŠ æ–°ä¾èµ–
source .venv/bin/activate
uv pip install package-name
pip freeze > requirements.txt

# æŸ¥çœ‹å·²å®‰è£…çš„åŒ…
source .venv/bin/activate
pip list
```

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®ä¸ºä¸ªäººé¡¹ç›®ã€‚