# 项目分析: Flai Agent (深壤 Agent)

## 项目概览
Flai Agent 是一个基于 FastAPI 构建的 AI 对话代理服务。它的设计目标是提供灵活的配置和强大的记忆功能。

### 核心功能
*   **多角色支持**: 通过 `config/prompts/characters.json` 配置多个角色。
*   **记忆系统**:
    *   **对话历史**: 存储在 MySQL (`t_dialogue`) 中，保留最近 30 天 20 轮对话。
    *   **持久化记忆**: 存储在 MySQL (`chat_memory`) 中，包括 LLM 提取的用户画像（长期和短期）。
    *   **向量记忆**: (可选) 使用 Qdrant 进行语义检索（相似度阈值0.8），以补充上下文。
*   **时间感知**: Pillow 角色能感知当前时间（精确到秒），并据此调整回复。
*   **情绪系统**: 能够识别用户情绪并调整 AI 的回复（支持多种情绪状态）。
*   **语音合成 (TTS)**: 集成语音服务，支持将文字转换为语音并上传到 OSS。
*   **热更新**: 支持在不重启服务的情况下更新 Prompt 和配置。
*   **日志系统**: 完善的日志记录，按日期归档。

### 优化任务 (进行中)
*   [x] **后台任务化**: 将 `memory.save_conversation` 移入 `FastAPI BackgroundTasks`，减少用户等待时间。
*   [x] **优化超时体验**: `LLMService` 增加超时设置 (15s) 和减少重试次数 (5->3)，避免长时间无响应。
*   [x] **单元测试**: 增加 `unit_test` 文件夹，并添加相关测试用例。
*   [x] **对话历史组装优化**: 将历史对话作为多个连续的用户/助手消息发送给LLM，而非嵌入到单个用户消息中
*   [x] **昵称偏好处理**: 增加对用户昵称偏好的识别与处理机制，确保正确理解用户角色关系
*   [x] **记忆上下文整合**: 将长短记忆描述直接整合到system prompt中，而非作为独立的system消息添加
*   [x] **Prompt模板优化**: 移除过时占位符，简化用户提示词模板
*   [x] **对话历史时间顺序修复**: 修正对话历史处理逻辑，确保按正确时间顺序排列，使LLM能正确理解上下文
*   [x] **语音参数传递修复**: 修复第三方角色对话历史查询中语音参数未正确传递的问题
*   [x] **用户消息与系统指令整合**: 重构用户消息结构，将用户输入和系统指令都放在content中但清晰区分，改善LLM理解
*   [x] **userId别名支持**: 为ChatRequest模型添加userId别名支持，提高API兼容性
*   [x] **Emoji处理**: 实现语音模式下禁用emoji，非语音模式下根据用户输入调整emoji回复策略
*   [x] **口癖词随机删除**: 实现50%概率删除单独的口癖词（如"哼"、"哈"、"哎呀"等）
*   [x] **对话历史轮数优化**: 修复硬编码7轮限制，改为取最近20轮对话，确保取的是最新对话而非最早对话
*   [x] **连续用户消息处理**: 当用户连续发送多条消息时，自动合并为一条，避免消息列表中出现连续的user角色
*   [x] **JSON格式提示位置优化**: 将JSON格式要求整合到system_prompt开头，而非作为单独的system消息
*   [x] **向量召回阈值优化**: 向量检索只返回相似度≥0.8的结果，过滤低质量召回
*   [x] **短期记忆时间精度**: 短期记忆时间戳从日期格式升级为精确到秒（YYYY-MM-DD HH:MM:SS）
*   [x] **短期记忆总结间隔**: 短期记忆总结间隔从7轮改为20轮
*   [x] **历史短期记忆按天合并**: 非当天的多条短期记忆自动按日期合并成一条总结，减少冗余

## 下一步计划 (建议)
*   验证 Qdrant 集成（如果需要向量记忆）。
*   扩展 `config/prompts/` 中的角色配置。
*   测试并微调情绪分析的准确性。